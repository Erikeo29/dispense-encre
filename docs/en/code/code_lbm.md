# Palabos Code - Lattice Boltzmann (LBM)

This page presents the C++ source files and XML configuration used for LBM simulations of shear-thinning ink dispensing.

---

## 1. Code Structure

The code is based on the **Palabos** library and structured to separate the solver logic (C++) from the configuration (XML).

```
project_directory/
├── src/
│   └── lbm_solver/
│       └── dropletCavity2D.cpp    # Main C++ source code
├── templates_lbm/
│   └── config/
│       └── simulation_template.xml # Configuration file
├── scripts/                       # Build and post-processing scripts
└── results/                       # Simulation outputs (VTK/VTI)
```

---

## 2. Simulation Configuration (`simulation_template.xml`)

This file defines numerical and physical parameters. It is read by the solver at startup or generated by parametric study scripts.

```xml
<!-- templates_lbm/config/simulation_template.xml -->

<simulation>
  <lbm>
    <nx>320</nx>                <!-- X Resolution -->
    <ny>120</ny>                <!-- Y Resolution -->
    <tau>1.0</tau>              <!-- Relaxation time (tau > 0.5) -->
    <G_fluid>-112.0</G_fluid>   <!-- Shan-Chen interaction strength -->
  </lbm>

  <contact_angles>
    <substrate>30</substrate>         <!-- Well bottom (hydrophilic) -->
    <isolant_left>45</isolant_left>   <!-- Left wall -->
    <isolant_right>90</isolant_right> <!-- Right wall (neutral) -->
    <left_platform>41</left_platform> <!-- Left platform -->
  </contact_angles>

  <rheology>
    <enable_carreau>true</enable_carreau>
    <eta0>1.5</eta0>            <!-- Zero-shear viscosity -->
    <eta_inf>0.001</eta_inf>    <!-- Infinite-shear viscosity -->
    <n>0.5</n>                  <!-- Power-law index -->
  </rheology>
</simulation>
```

**Key points:**
- **G_fluid**: Critical parameter of the Shan-Chen model controlling surface tension and phase separation
- **tau**: Linked to kinematic viscosity by $\nu = c_s^2 (\tau - 0.5)$
- **contact_angles**: Defines the wettability of each surface in the cavity

---

## 3. Geometry and Regions (`dropletCavity2D.cpp`)

The cavity geometry is defined analytically in the C++ code. The `getWallRegion` function identifies the type of each cell (wall, bottom, platform) to apply the correct boundary condition.

```cpp
// src/lbm_solver/dropletCavity2D.cpp

enum WallRegion {
    WALL_NONE = 0,
    WALL_LEFT_PLATFORM,    // Left platform
    WALL_LEFT_VERTICAL,    // Left vertical wall
    WALL_BOTTOM,           // Well bottom
    WALL_RIGHT_VERTICAL,   // Right vertical wall
    // ...
};

WallRegion getWallRegion(plint iX, plint iY) {
    // Well bottom (y = 0, between walls)
    if (iY == 0 && iX > wellStartX && iX < wellEndX) return WALL_BOTTOM;

    // Left vertical wall (fixed x, limited height)
    if (iX == wellStartX && iY < wellDepth) return WALL_LEFT_VERTICAL;

    // Left platform (elevated y)
    if (iY == wellDepth && iX <= wellStartX) return WALL_LEFT_PLATFORM;

    // ... other geometric conditions ...
    return WALL_NONE;
}
```

**Key points:**
- **Explicit Geometry**: Allows precise definition of sharp cavity edges
- **Distinct Regions**: Each zone can have a different contact angle

---

## 4. Contact Angle Management

In Shan-Chen LBM, the contact angle is imposed by a fictitious density in the wall. The `computeWallDensity` function calculates this density based on the desired angle.

```cpp
// Wall density calculation for a given angle
T computeWallDensity(T theta, T rhoGas, T rhoLiq) {
    if (theta >= 90.0) {
        // Hydrophobic / Neutral case
        return rhoGas * (180.0 - theta) / 90.0;
    } else {
        // Hydrophilic case
        return rhoGas + (rhoLiq - rhoGas) * (90.0 - theta) / 90.0;
    }
}

// Progressive activation to avoid condensation artifacts
// (Only when liquid touches the wall)
if (liquidNearby) {
    T rhoWall = rho_neutral;
    switch (region) {
        case WALL_BOTTOM: rhoWall = rhoWall_bottom; break;
        case WALL_LEFT_VERTICAL: rhoWall = rhoWall_leftVert; break;
        // ...
    }
    defineDynamics(lattice, box, new BounceBack<T, DESCRIPTOR>(rhoWall));
}
```

**Key points:**
- **Virtual Density**: Modifies the interaction potential near walls
- **Dynamic Activation**: Wetting properties are only activated upon fluid contact to prevent parasitic condensation on hydrophilic surfaces

---

## 5. Non-Newtonian Rheology (Carreau Model)

The shear-thinning behavior of the ink is implemented via a data processor that locally adjusts the relaxation time $\tau$ (and thus viscosity) based on the shear rate.

```cpp
// src/lbm_solver/dropletCavity2D.cpp - CarreauRheologyProcessor

// 1. Strain rate tensor calculation S_ab
T Sxx = -1.5 * omegaRef * Pi_xx / rho;
T Syy = -1.5 * omegaRef * Pi_yy / rho;
T Sxy = -1.5 * omegaRef * Pi_xy / rho;

// 2. Shear magnitude (gamma dot)
T gammaDot = std::sqrt(2.0 * (Sxx*Sxx + Syy*Syy + 2.0*Sxy*Sxy));

// 3. Local viscosity calculation (Carreau Model)
// nu = nuInf + (nu0 - nuInf) * [1 + (lambda * gammaDot)^2]^((n-1)/2)
T factor = std::pow(1.0 + std::pow(lambda * gammaDot, 2), (n - 1.0) / 2.0);
T nuLocal = nuInf + (nu0 - nuInf) * factor;

// 4. Relaxation update
T omegaLocal = 1.0 / (3.0 * nuLocal + 0.5);
```

**Key points:**
- **Local Calculation**: Viscosity is recomputed at every point and every time step
- **Stability**: Bounds (`tauMin`, `tauMax`) are applied to ensure numerical stability

---

## 6. Droplet Initialization

The droplet is initialized with a smoothed density profile (hyperbolic tangent) to minimize acoustic waves at startup.

```cpp
// Smooth interface initialization
T interfaceWidth = 4.0;
T phi = 0.5 * (1.0 - tanh(2.0 * (dist - radius) / interfaceWidth));
T rho = rhoOut + phi * (rhoIn - rhoOut);
```

**Key points:**
- **Diffuse Interface**: Intrinsic characteristic of the Shan-Chen model (3-4 cells thick)
- **Equilibration**: A "warmup" phase without gravity allows the droplet to assume its spherical shape and equilibrium densities before impact

```